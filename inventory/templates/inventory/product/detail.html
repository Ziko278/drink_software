{% extends 'admin_site/layout.html' %}
{% load static %}
{% load humanize %}

{% block 'main' %}
<div class="col-lg-12 grid-margin stretch-card">
    <div class="card">
        <div class="card-body">
            <h4 class="card-title">ACTIONS:
                <a class="btn btn-warning" href="{% url 'product_edit' product.id %}" title="Edit Product"><i
                        class="bi bi-pencil-square"></i></a>
                <a class="btn btn-danger" href="{% url 'product_delete' product.id %}" title="Delete Product"><i
                        class="bi bi-trash"></i></a>

                <button class="btn btn-danger" onclick="window.history.back()" title="Go Back"><i
                        class="bi bi-arrow-left"></i></button>

            </h4>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body pt-3">
                <ul class="nav nav-tabs nav-tabs-bordered">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-target="#profile-overview" data-bs-toggle="tab">PRODUCT
                            DATA</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" data-bs-target="#stock-history" data-bs-toggle="tab">STOCK HISTORY</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" data-bs-target="#price-history" data-bs-toggle="tab">PRICE HISTORY</a>
                    </li>



                </ul>

                <div class="tab-content pt-2">
                    <div class="tab-pane fade show active profile-overview" id="profile-overview">

                        <div class="col-12 grid-margin">
                            <div class="row">
                                <div class="col-xxl-8 col-md-8">
                                    <div class="card info-card sales-card">
                                        <div class="card-body">
                                            <h5 class="card-title"></h5>
                                            <div class="d-flex align-items-center">
                                                <div class="card-icon rounded-circle d-flex bg-primary align-items-center justify-content-center">
                                                    <i class="bi bi-alarm-fill text-white"></i>
                                                </div>
                                                <div class="ps-3">
                                                    <h6>{{ product.name|title }}</h6>
                                                    <span class="text-muted small pt-2 ps-1">Product Name</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                                <div class="col-xxl-4 col-md-4">
                                    <div class="card info-card sales-card">
                                        <div class="card-body">
                                            <h5 class="card-title"></h5>
                                            <div class="d-flex align-items-center">
                                                <div class="card-icon rounded-circle bg-success d-flex align-items-center justify-content-center">
                                                    <i class="bi bi-alarm-fill text-white"></i>
                                                </div>
                                                <div class="ps-3">
                                                    <h6>{{ product.category|title }}</h6>
                                                    <span class="text-muted small pt-2 ps-1">Category</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-xxl-4 col-md-4">
                                    <div class="card info-card sales-card">
                                        <div class="card-body">
                                            <h5 class="card-title"></h5>
                                            <div class="d-flex align-items-center">
                                                <div class="card-icon rounded-circle d-flex bg-warning align-items-center justify-content-center">
                                                    <i class="bi bi-alarm-fill text-white"></i>
                                                </div>
                                                <div class="ps-3">
                                                    <h6>{{ product.quantity }}</h6>
                                                    <span class="text-muted small pt-2 ps-1">Available Quantity</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-xxl-4 col-md-4">
                                    <div class="card info-card sales-card">
                                        <div class="card-body">
                                            <h5 class="card-title"></h5>
                                            <div class="d-flex align-items-center">
                                                <div class="card-icon rounded-circle d-flex bg-danger align-items-center justify-content-center">
                                                    <i class="bi bi-alarm-fill text-white"></i>
                                                </div>
                                                <div class="ps-3">
                                                    <h6>â‚¦{{product.selling_price|intcomma}}</h6>
                                                    <span class="text-muted small pt-2 ps-1">Selling Price</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-xxl-4 col-md-4">
                                    <div class="card info-card sales-card">
                                        <div class="card-body">
                                            <h5 class="card-title"></h5>
                                            <div class="d-flex align-items-center">
                                                <div class="card-icon rounded-circle d-flex bg-primary align-items-center justify-content-center">
                                                    <i class="bi bi-alarm-fill text-white"></i>
                                                </div>
                                                <div class="ps-3">
                                                    <h6>{{ product.reorder_level }}</h6>
                                                    <span class="text-muted small pt-2 ps-1">Reorder Level</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                            </div>
                            <div class="card">
                                <div class="card-body" style="padding:20px">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <p class="card-title"> PRODUCT SUPPLIERS </p>

                                            <div class="row">
                                                {% for supplier in supplier_list %}
                                                <div class="col-md-12">
                                                    <div class="card">
                                                        <div class="card-body">
                                                            <h4 class="card-title"> {{supplier|title}} </h4>
                                                            <p>Contact Person: {{supplier.contact_person|title}} </p>
                                                            <p>Phone Number: {{supplier.phone_number}} </p>
                                                            <p>Email: {{supplier.email|lower}} </p>
                                                            <p>Address: {{supplier.address}} </p>
                                                        </div>
                                                    </div>

                                                </div>
                                                {% empty %}
                                                <h4 class="card-title text-center">No Available Supplier Recorded for {{product.name|title}}</h4>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="tab-pane fade pt-3" id="stock-history">
                        <h5 class="card-title">Stock History of {{product.name|title}}</h5>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover table-borderless datatable">
                                                <thead>
                                                <tr>
                                                    <th>Qty Added</th>
                                                    <th>Cost Price (â‚¦)</th>
                                                    <th>Qty Left</th>
                                                    <th>Qty Sold</th>
                                                    <th>Qty Stocked Out</th>
                                                    <th>Date</th>
                                                    <th>Status</th>
                                                    <th>Staff </th>
                                                    <th>Action</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                {% for stock in stock_list %}
                                                <tr>
                                                    <td>{{ stock.quantity_added|floatformat }}</td>
                                                    <td>{{ stock.unit_cost_price|intcomma }}</td>
                                                    <td>{{ stock.quantity_left|floatformat }}</td>
                                                    <td>{{ stock.quantity_sold|floatformat }}</td>
                                                    <td>{{ stock.quantity_stocked_out|floatformat }}</td>
                                                    <td>{{ stock.date_added }}</td>
                                                    <td class="{% if stock.status|lower == 'active' %} text-success {% else %} text-danger {% endif %}">{{ stock.status|title }}</td>
                                                    <td>{% if stock.created_by %}<a href="{% url 'staff_detail' stock.created_by.id %}">{{ stock.created_by|title }}</a>{% endif %}</td>
                                                    <td>
                                                        {% if stock.status == 'active' %}<button type="button" title="Stock Out Product" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#verticalycentered{{forloop.counter}}"><i class="bi bi-arrow-right"></i> </button>{% endif %}
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td class="text-center" colspan="7">No Stock found.</td>
                                                </tr>
                                                {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="tab-pane fade pt-3" id="price-history">
                        <h5 class="card-title">Price Change History of {{product.name|title}}</h5>
                        <div class="card">
                            <div class="card-body">
                                   <div id="reportsChart"></div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>


        </div>
    </div>
</div>

<script>
                    document.addEventListener("DOMContentLoaded", () => {
                      new ApexCharts(document.querySelector("#reportsChart"), {
                        series: [{
                          name: 'Price',
                          data: [{% for price in price_history_list %} {{price.new_price}}, {% endfor %}],
                        }],
                        chart: {
                          height: 350,
                          type: 'area',
                          toolbar: {
                            show: false
                          },
                        },
                        markers: {
                          size: 4
                        },
                        colors: ['#4154f1', '#2eca6a', '#ff771d'],
                        fill: {
                          type: "gradient",
                          gradient: {
                            shadeIntensity: 1,
                            opacityFrom: 0.3,
                            opacityTo: 0.4,
                            stops: [0, 90, 100]
                          }
                        },
                        dataLabels: {
                          enabled: false
                        },
                        stroke: {
                          curve: 'smooth',
                          width: 2
                        },
                        xaxis: {
                          type: 'datetime',
                          categories: [{% for price in price_history_list %} '{{price.change_date|date:"Y:m:d"}}', {% endfor %}]
                        },
                        tooltip: {
                          x: {
                            format: 'dd/MM/yy'
                          },
                        }
                      }).render();
                    });
                  </script>

{% for stock in stock_list %}
<form method="POST" action="{% url 'stock_out_create' %}">
    {% csrf_token %}
    <div class="modal fade" id="verticalycentered{{forloop.counter}}" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="card-title">Stock Out {{ product|title }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-floating">
                                <input type="number" min="1" max="{{stock.quantity_left}}" class="form-control" name="quantity_removed" required>
                                <input type="hidden" name="stock" value="{{ stock.id }}" />
                                <label for="floatingName">Quantity <span style="color:red"><b>*</b></span></label>
                            </div><br />
                        </div>

                        <div class="col-md-12">
                            <div class="form-floating">
                                {{ stock_out_form.reason }}
                                <label for="floatingName">Reason for Removal <span style="color:red"><b>*</b></span></label>
                            </div><br />
                        </div>

                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Confirm</button>
                </div>
            </div>
        </div>
    </div>
</form>

{% endfor %}
{% endblock %}